## 环境说明

* 预安装Ubuntu、Nginx、PHP、MariaDB、OpenLDAP、MongoDB、Node、Composer、Git
* 所有服务都构建在Ubuntu之上
* 安装配置完成后开机启动Nginx、PHP-FPM、MariaDB
* 并通过service来统一管理服务的启动停止重启功能
* 日志文件统一保存到/var/log目录下
* sysv-rc-conf --list查看服务的启动情况

## 搭建Linux虚拟机

说明：使用Vagrant搭建一个Linux的虚拟机，Vagrant与传统的Vmware和VirtualBox构建虚拟机有什么区别呢？对我来说它更轻量级以及更便捷使用，对使用者非常便捷友好，实际上Vagrant我们也可以这么理解“它是构建在Vmware或VirtualBox之上的一个上层用户友好的虚拟软件”

### 更新软件

`sudo apt-get update`更新已经安装了的程序，在很多程序中都需要ssl,xml的支持因此我们提前把几个需要使用的库给安装好libxml2,libxml2-dev,libssl,libsll-dev

## 安装Nginx

Nginx可以直接使用apt-ge install nginx来进行安装。我们在安装完成Nginx和PHP后，重要的部分是配置使其能够很好的协同工作，现在大部分采用的是Nginx+PHPFPM的组合形式，这种组合在性能和高并发的处理上比Apache+php，Nginx+fastcgi要优秀很多。[PHP在Unix下的安装](http://php.net/manual/zh/install.unix.nginx.php)这里有官方的介绍，根据自己的实际需求做适当的调整就可以了。有一点需要说明的是Linux对权限控制室很严格的，所有建议把Nginx和PHP-FPM使用同一个用户和组

使用说明：

配置文件：/etc/nginx
日志文件：/var/log/nginx

## 安装OpenLDAP

OpenLDAP需要berkeleydb的支持，所以在安装之前我们需要先去Oracle下载[berkeleydb](http://www.oracle.com/technetwork/database/database-technologies/berkeleydb/downloads/index.html)并安装，采用标准的安装方式就可以了没有什么需要注意的地方。

berkeleydb的安装需要注意的地方就是openldap对它有版本限制，所以最新的稳定版不一定被支持所以安装之前先看下openldap的安装文档说明，我自己在安装的时候在openldap的文档里发现：

>Berkeley DB version 6.0.20 and later uses a software license that is incompatible with LDAP technology and should not be used with OpenLDAP.

如果安装了错误的berkeley在openldap的安装过程中就会报错

>error: BerkeleyDB version incompatible with BDB/HDB backends

### BerkeleyDB的安装

* tar xvf db-5.3.28.zip
* cd db-5.3.28/build_unix
* ../dist/configure --prefix=/usr/local/berkeleydb
* make && make install
* cp /usr/local/berkeleydb/include/* /usr/include
* cp /usr/local/berkeleydb/lib/* /usr/lib
* env CPPFLAGS="I/usr/local/berkeleydb/include" LDFLAGS="L/usr/local/berkeleydb/lib"
* 接下里就可以安装openldap了

## 安装MariaDB

[MariaDB](https://downloads.mariadb.org/)的安装在其文档上有很详细的描述，根据自己的版本选择相应的package来安装就可以了。安装期间可能会需要设置一下root用户的密码，根据自己的需要填写即可,hhua1120

安装说明：
安装是根据MariaDB官网上推荐的Ubuntu安装方式，没有做其他修改
>Here are the commands to run to install MariaDB on your Ubuntu system:


```
sudo apt-get install software-properties-common
sudo apt-key adv --recv-keys --keyserver hkp://keyserver.ubuntu.com:80 0xcbcb082a1bb943db
sudo add-apt-repository 'deb [arch=amd64,i386,ppc64el] http://mirrors.neusoft.edu.cn/mariadb/repo/5.5/ubuntu trusty main'
```

>Once the key is imported and the repository added you can install MariaDB with:

```
sudo apt-get update
sudo apt-get install mariadb-server
```

使用说明：
配置文件：/etc/mysql/my.cnf
运行停止：service mysql start(stop|restart)，已经开启了开机启动
错误日志：错误日志位置是根据my.conf配置的，默认保存在/var/log/mysql/error.log

### 与PHP配合使用

在PHP中使用mysql的相关函数，如果只是按照PHP和MariaDB显然是不够的。我们使用mysqli_real_connect()函数会发现报错`mysqli_real_connect(): (HY000/2002): No such file or directory`，但是我们在命令行界面发现数据库确实已经启动了，导致这个问题的原因是因为PHP查找mysql.sock这个文件找不到导致的。怎么发现找不到呢？
* 进入mysql命令行界面，使用status查看状态找到UNIX Socket对应的位置(我的事/var/run/mysqld/mysqld.sock)
* 我们编译一个phpinfo()的PHP文件，查看相关的default_socket(mysql、mysqli、pdo_mysql)涉及这三个，发现有的为空而有的指向了/tmp/mysql.sock
* 很显然在/tmp下没有相关的文件，因为查找的位置不一样所以无法正确的配合使用
* 方法一：ln -s /var/run/mysqld/mysqld.sock /tmp/mysql.sock
* 方法二：修改php.ini里面的上面提到的三个配置项，使其指定到/var/run/mysqld/mysqld.sock

## 安装MondoDB

[Install mondodb on ubuntu](https://docs.mongodb.com/manual/tutorial/install-mongodb-on-ubuntu/)提供了官方的安装文档，通过package安装是最便捷的安装形式

>sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv EA312927
>echo "deb http://repo.mongodb.org/apt/ubuntu trusty/mongodb-org/3.2 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-3.2.list
>sudo apt-get update
>sudo apt-get install -y mongodb-org

配置文件：/etc/mongod.conf
日志文件：/var/log/mongodb

## 安装PHP

因为需要使用ldap以及curl，所以我们需要把相应的软件和库都安装好才能正确的安装PHP。当然我们也可以直接编译安装，根据错误提示信息来一步一步的解决问题（我自己就是这么做的，因为不可能提前把所有的依赖都安装好）因为需要支持curl，在编译安装PHP的时候报错找不到curl对应的依赖，上网查找通过`sudo apt-get install libcurl4-openssl-dev`解决了这个问题

```
./configure --prefix=/usr/local/php --with-config-file-path=/usr/local/php/etc --enable-inline-optimization --disable-debug --enable-bcmath --enable-clendar --enable-ctype --enable-ftp --enable-gd-native-ttf --enable-magic-quotes --enable-shmop --disable-sigchild --enable-sysvsem --enable-sysvshm --enable-wddx --with-openssl  --with-xsl=/usr/local/php --enable-fpm --with-curl=/usr/local/php --with-ldap --with-mysqli --with-pdo-mysql
```

使用说明：
启动：使用php-fpm的方式启动，php-fpm文件位于/usr/local/php/sbin文件下。php-fpm的配置文件位于/usr/local/php/etc文件下，查看配置文件php-fpm.cnf可以了解很多很信息，其中就包括了pid的默认保存位置处于/usr/local/php/var/run下（这里需要注意的是如果权限不够，这个pid文件在启动的时候没法生成）。

停止：kill -INT 'cat /usr/local/php/var/run/php-fpm.pid'

重启：kill -USR2 'cat /usr/local/php/var/run/php-fpm.pid'

如果不知道pid文件的位置，我们也可以通过ps -ef|grep php-fpm找到主进程的pid号，用pid号来代替上文提到的pid文件

这种启动停止的方式特别不方便，如何也像nginx，mysql那样通过service来进行处理呢？这个在我们编译php的时候已经有相应的脚本自动生成了，脚本文件位于php编译目录下sapi/fpm/init.d.php-fpm这是一个可执行的脚本，可以进去修改查看。如果我们修改了php-fpm.cnf那么这个脚本也需要做修改（这个脚本主要是通过pid文件来执行操作，所以如果修改了pid文件的位置那么这个脚本也需要修改）

```
cp php/sapi/fpm/init.d.php-fpm /etc/init.d/php-fpm
chmod 755 /etc/init.d/php-fpm
chkconfig --add php-fpm(现在Ubuntu上已经不支持试用chkconfig使用apt-get install chkconfig不能正确安装，推荐使用sysv-rc-conf,apt-get install sysv-rc-conf。查看了很多这方面的说明，网上很多人建议在Ubuntu下使用Upstart来进行管理，有兴趣的可以自己去琢磨)
sysv-rc-conf --level 2345 php-fpm on
service php-fpm start(stop|restart)
```

php-fpm配置文件：/usr/local/php/etc
php配置文件：/usr/local/php/etc
php错误日志：/var/log/php

## 添加扩展

PHP在安装完成后，有可能会因为业务的愿意需要添加额外的扩展。这个时候我们可以进入我们编译php的目录（php安装完成后这个编译目录建议保留）里面有个ext下面有很多我们可能会用到的扩展的源代码，以iconv为例

```
cd ext/iconv
phpize
./configure
make
make install
```

这个过程会自动生成动态扩展文件，有的版本会自动更新php.ini并自动把扩展文件保存到响应目录。总之可以查看输出来了解详情


### 安装中出现的问题

* configure: error: Cannot find ldap libraries in /usr/lib.

这个问题是找不到ldap库导致的，实际上我们已经安装了openldap。解决这个问题很简单，进入openldap的安装目录，把相应的libldap复制到/usr/lib即可

```
cd /usr/local/openldap/bin
sudo cp libldap.* /usr/lib
```

## 安装PHP的MongoDB扩展

Ubuntu下最简单的[安装方式](http://php.net/manual/zh/mongodb.installation.pecl.php)就是`sudo pecl install mongodb`，pecl可以在php的安装文件夹里面找到，我的位置是在/usr/local/php/bin下面。安装过程中可能会报错关于autoconf的错误，`sudo apt-get install autoconf`即可

## 安装Composer

Linux下Composer的安装需要使用到php执行文件，[Command-line installation](https://getcomposer.org/download/)官方网站上安装程序按照流程就可以了。有几个地方需要注意

```
move composer.phar /usr/local/bin/composer(Now just run composer in order to run Composer instead of php composer.phar.)
```

通过使用上面的命令我们就可以直接使用`composer`命令，当然如果你的php不能直接在命令行使用的话也会报错`/usr/bin/env: php: No such file or directory`。解决这个问题有几个方法百度上面都能找到

>修改/etc/profile文件使其永久性生效，并对所有系统用户生效，在文件末尾加上如下两行代码

>PATH=$PATH:/usr/local/php/bin

>export PATH

## Node安装

[Node安装](https://nodejs.org/en/download/package-manager/)官方提供了详实的安装文档，根据自己的linux发布版本选择就OK了